# 🎵 烟花模拟器 - 音频系统说明

## 📋 音频功能

### ✅ 已实现的功能

1. **背景音乐播放**
   - 自动循环播放 `Happy-New-Year-A-Teens.mp3`
   - 音量：30%（可在代码中调整）
   - 与声音按钮联动

2. **烟花音效**
   - 🚀 **发射音效** (lift) - 烟花发射时播放
   - 💥 **爆炸音效** (burst) - 主爆炸声
   - ✨ **爆裂音效** (crackle) - 大型爆裂声
   - ⚡ **小爆裂音效** (crackleSmall) - 小型连续爆裂声
   - 💫 **小爆炸音效** (burstSmall) - 复杂烟花的额外爆炸

3. **增强的爆竹音效**
   - 大型烟花（≥2号）：多层次爆裂音
   - 爆裂型烟花：连续3次小爆裂音
   - 复杂烟花（pistil/ring）：额外的小爆炸音效
   - 所有音效都有随机延迟和音量变化，更真实

4. **智能音效系统**
   - 自动检测file://和http://协议
   - file://协议使用XMLHttpRequest加载
   - http://协议使用fetch API加载
   - 音效加载失败时自动降级，不影响其他功能

## 🎮 使用方法

### 方法1：通过本地服务器（推荐）

```bash
# 在项目目录中启动服务器
python3 -m http.server 8000

# 然后在浏览器中访问
http://localhost:8000/index.html
```

**优点：**
- ✅ 所有功能完全正常
- ✅ 无跨域问题
- ✅ 音效加载更快
- ✅ 支持所有现代浏览器

### 方法2：直接打开HTML文件

直接在Chrome中打开 `index.html` 文件（file://协议）

**说明：**
- ✅ 现在支持file://协议
- ✅ 自动使用XMLHttpRequest加载音频
- ✅ 音效和背景音乐都能正常工作
- ⚠️ 首次使用可能需要授予文件访问权限

## 🔧 操作步骤

1. **启用声音**
   - 打开页面后，点击右上角的 🔇 图标
   - 图标变成 🔊 表示声音已启用

2. **调试音效**
   - 按 `F12` 打开开发者工具
   - 在Console中查看音频加载状态
   - 输入 `debugFireworkSound()` 运行测试

3. **查看日志**
   Console中会显示：
   ```
   🎵 音频加载模式: file:// (本地文件) 或 http:// (服务器)
   ✅ 背景音乐加载成功
   ✅ 音效加载成功 [burst]: 2/2 个文件
   🔊 启用声音，音频上下文状态: suspended
   ✅ 音频上下文已启动: running
   🔊 播放音效: burst, 音量: 0.85, 上下文状态: running
   ```

## 🐛 常见问题

### Q: 为什么听不到声音？
**A:** 请确保：
1. 点击了声音按钮（🔇 → 🔊）
2. 系统音量已开启
3. 浏览器标签页没有被静音
4. 查看Console是否有错误信息

### Q: file://协议下音效不正常？
**A:** 新版本已修复此问题。如果仍有问题：
1. 确保所有音频文件都在 `audio/` 目录中
2. 检查文件名是否正确
3. 查看Console中的加载日志
4. 尝试使用本地服务器方式

### Q: 只有部分音效正常？
**A:** 这是正常的容错机制：
- 系统允许部分音效加载失败
- 查看Console中的加载状态
- 确认audio文件夹中的文件完整性

### Q: Chrome显示"AudioContext was not allowed to start"？
**A:** 新版本已修复。AudioContext现在在用户点击声音按钮时立即启动。

## 📁 音频文件列表

### 背景音乐
- `Happy-New-Year-A-Teens.mp3` - 背景音乐

### 音效文件
- `lift1.mp3`, `lift2.mp3`, `lift3.mp3` - 发射音效
- `burst1.mp3`, `burst2.mp3` - 爆炸音效
- `burst-sm-1.mp3`, `burst-sm-2.mp3` - 小爆炸音效
- `crackle1.mp3` - 爆裂音效
- `crackle-sm-1.mp3` - 小爆裂音效

## 🎨 自定义配置

### 修改背景音乐音量
在 `js/script.js` 中找到：
```javascript
bgMusicVolume: 0.3,  // 0.0-1.0，默认30%
```

### 更换背景音乐
1. 将新的音乐文件放入 `audio/` 目录
2. 在 `js/script.js` 中修改：
```javascript
bgMusicFile: "your-music.mp3",
```

### 调整音效音量
在 `js/script.js` 中的 `sources` 对象中修改各音效的 `volume` 值

## 🎆 测试页面

项目包含一个音效测试页面：`test_sound.html`

功能：
- 测试每个音效单独播放
- 测试背景音乐播放
- 模拟完整烟花音效序列
- 显示详细的加载状态

访问方式：
- http://localhost:8000/test_sound.html

## 📝 技术说明

### 音频加载策略
- **file:// 协议**：使用 XMLHttpRequest
  - 兼容性好
  - 状态码为0时也认为成功
  - 适合本地文件系统

- **http:// 协议**：使用 Fetch API
  - 标准化的现代API
  - 更好的Promise支持
  - 适合服务器环境

### AudioContext状态管理
- `suspended` - 初始状态，需要用户交互才能启动
- `running` - 正常播放状态
- 用户点击声音按钮时立即调用 `resume()`，符合Chrome策略

### 容错机制
- 部分音效加载失败不影响其他音效
- 自动过滤null buffer
- 详细的日志输出便于调试

## 🚀 性能优化

1. **音效复用** - 使用音频buffer池，避免重复加载
2. **节流控制** - 小型爆炸音效有20ms的节流
3. **延迟播放** - 次级音效使用随机延迟，分散性能压力
4. **音量缩放** - 根据烟花大小动态调整音量

---

**版权所有 © 2022 NianBroken**
